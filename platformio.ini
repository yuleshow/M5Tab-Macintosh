; PlatformIO Project Configuration File
; BasiliskII ESP32 - Macintosh Emulator for M5Stack Tab5
;
; Using Arduino framework with optimized memory settings
;

[env:esp32p4_pioarduino]
platform = https://github.com/pioarduino/platform-espressif32.git#54.03.21
upload_speed = 1500000
monitor_speed = 115200
build_type = release
framework = arduino
board = esp32-p4-evboard
board_build.mcu = esp32p4
board_build.flash_mode = qio
board_build.partitions = partitions.csv

; Pre-build scripts
extra_scripts =
    pre:scripts/add_toolchain_path.py
    pre:scripts/pre_build.py

; Build flags for BasiliskII
build_flags =
    ; Fix missing sdkconfig.h issue by adding correct include path
    -I ~/.platformio/packages/framework-arduinoespressif32-libs/esp32p4/qio_qspi/include
    ; PSRAM and debug settings
    -DBOARD_HAS_PSRAM
    -DCORE_DEBUG_LEVEL=3
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=1
    ; Optimize for speed (CPU emulation performance)
    -O2
    -ffunction-sections
    -fdata-sections
    -fno-common
    -fno-rtti
    -fno-exceptions
    -funroll-loops
    -fomit-frame-pointer
    ; BasiliskII configuration
    -DEMULATED_68K=1
    -DREAL_ADDRESSING=0
    -DDIRECT_ADDRESSING=0
    -DROM_IS_WRITE_PROTECTED=1
    -DSAVE_MEMORY_BANKS=1
    -DFLIGHT_RECORDER=0
    -DNO_INLINE_MEMORY_ACCESS=0
    ; Data type sizes for ESP32 (32-bit RISC-V)
    -DSIZEOF_SHORT=2
    -DSIZEOF_INT=4
    -DSIZEOF_LONG=4
    -DSIZEOF_LONG_LONG=8
    -DSIZEOF_VOID_P=4
    ; FPU configuration
    -DFPU_IEEE=1
    -DFPU_UAE=0
    -DFPU_X86=0
    ; Disable features not available on ESP32
    -DENABLE_MON=0
    -DUSE_JIT=0
    ; Include paths for BasiliskII
    -I src/basilisk
    -I src/basilisk/include
    -I src/basilisk/uae_cpu
    -I src/basilisk/uae_cpu/fpu
    -I src/basilisk/uae_cpu/generated
    ; Compiler warnings - disable noisy ones
    -Wno-unused-variable
    -Wno-unused-function
    -Wno-unused-but-set-variable
    -Wno-sign-compare
    -Wno-missing-field-initializers
    -Wno-return-type
    -Wno-deprecated-enum-enum-conversion
    -Wno-pointer-arith
    ; Linker flags to reduce BSS
    -Wl,--gc-sections
    ; Allow linker to split sections across non-contiguous regions
    -Wl,--enable-non-contiguous-regions

; Linker flags to reduce binary size and handle memory layout  
build_unflags =

; Source filter - include basilisk sources, exclude conflicting files
build_src_filter =
    +<*>
    +<basilisk/*.cpp>
    +<basilisk/uae_cpu/*.cpp>
    +<basilisk/uae_cpu/fpu/fpu_esp32.cpp>
    +<basilisk/uae_cpu/generated/cpudefs.cpp>
    +<basilisk/uae_cpu/generated/cpuemu.cpp>
    +<basilisk/uae_cpu/generated/cpustbl.cpp>
    -<basilisk/ESP32/*>
    -<basilisk/audio.cpp>
    -<basilisk/audio_dummy.cpp>
    -<basilisk/ether.cpp>
    -<basilisk/ether_dummy.cpp>
    -<basilisk/scsi.cpp>
    -<basilisk/scsi_dummy.cpp>
    -<basilisk/serial.cpp>
    -<basilisk/serial_dummy.cpp>
    -<basilisk/clip_dummy.cpp>

lib_deps =
    https://github.com/M5Stack/M5Unified.git
    https://github.com/M5Stack/M5GFX.git
